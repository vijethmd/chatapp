<!DOCTYPE html>
<html lang="en">
<%- include('partials/head', { title: 'My Messages' }) %>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark shadow-sm">
  <div class="container-fluid">
    <a href="/" class="navbar-brand fw-bold">ðŸ’¬ ChatApp</a>
    <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
  </div>
</nav>

<div class="container-fluid mt-4">
  <div class="row">

    <!-- Left panel: New Message + Users -->
    <div class="col-md-3">
      <!-- New Message Form -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title mb-3 text-center fw-bold">New Message</h5>
          <form action="/mymessages/send" method="POST" class="d-flex flex-column gap-2">
            <input type="text" name="toUsername" class="form-control" placeholder="Recipient username" required>
            <textarea name="message" class="form-control" placeholder="Type your message..." rows="3" required></textarea>
            <button class="btn btn-success w-100 fw-bold">Send</button>
          </form>
        </div>
      </div>

      <!-- Existing Chats -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3 fw-bold">Chats</h5>
          <div class="list-group overflow-auto" style="max-height: 400px;">
            <% users.forEach(u => { %>
              <a href="/mymessages/<%= u.id %>" class="list-group-item list-group-item-action <%= activeUser && activeUser.id == u.id ? 'active fw-bold text-white' : '' %>">
                <i class="bi bi-person-circle me-2"></i> <%= u.username %>
              </a>
            <% }) %>
          </div>
        </div>
      </div>
    </div>

    <!-- Right panel: Chat thread -->
    <div class="col-md-9">
      <% if (activeUser) { %>
        <h5 class="mb-3">Chat with <%= activeUser.username %></h5>
        <div class="chat-thread border rounded p-3 mb-3 bg-white" style="height: 400px; overflow-y: scroll;">
          <% messages.forEach(m => { %>
            <div class="d-flex flex-column mb-2 <%= m.sender_id === user.id ? 'align-items-end' : 'align-items-start' %>">
              <div class="p-2 rounded <%= m.sender_id === user.id ? 'bg-primary text-white' : 'bg-light text-dark' %>" style="max-width: 70%;">
                <div class="fw-bold mb-1"><%= m.sender_id === user.id ? 'You' : m.senderName %></div>
                <div><%= m.message %></div>
                <small class="text-muted"><%= m.formatted_time %></small>
              </div>
            </div>
          <% }) %>
        </div>

        <!-- Send message in thread -->
        <form action="/mymessages/<%= activeUser.id %>/send" method="POST" class="d-flex gap-2">
          <input type="text" name="message" class="form-control" placeholder="Type a message..." required>
          <button class="btn btn-primary">Send</button>
        </form>
      <% } else { %>
        <p class="text-muted">Select a user or start a new conversation to see the chat.</p>
      <% } %>
    </div>

  </div>
</div>

</body>
</html>
